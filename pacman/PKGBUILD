pkgname=asimov-cli
pkgver=25.0.0_dev.2
pkgrel=1
pkgdesc="Asimov CLI Tool"
arch=('x86_64' 'aarch64')
url="https://github.com/asimov-platform/asimov-cli"
license=('MIT')
depends=()

# Use the correct release assets
source_x86_64=("https://github.com/asimov-platform/asimov-cli/releases/download/25.0.0-dev.2/asimov-linux-x86.gz")
source_aarch64=("https://github.com/asimov-platform/asimov-cli/releases/download/25.0.0-dev.2/asimov-linux-arm.gz")

sha256sums_x86_64=("a64251f846d0cc0280a7f83f25f0db0c4f15ef4caf349ccd45dad22250866060")
sha256sums_aarch64=("e9ca2393fe6147a01f10a36bd162b8f014fcfc1e964bb65a33e6d0920b34960d")

package() {
    cd "$srcdir"

    # Determine the correct filename
    if [[ "$CARCH" == "x86_64" ]]; then
        source_file="asimov-linux-x86.gz"
    elif [[ "$CARCH" == "aarch64" ]]; then
        source_file="asimov-linux-arm.gz"
    else
        echo "‚ùå Error: Unsupported architecture $CARCH"
        exit 1
    fi

    # Debugging: Show file details before extraction
    echo "üîç Checking $source_file before extraction"
    ls -lah "$source_file"
    sha256sum "$source_file"
    file "$source_file"

    # Ensure file integrity
    actual_sha=$(sha256sum "$source_file" | awk '{print $1}')
    expected_sha=""
    if [[ "$CARCH" == "x86_64" ]]; then
        expected_sha="${sha256sums_x86_64[0]}"
    elif [[ "$CARCH" == "aarch64" ]]; then
        expected_sha="${sha256sums_aarch64[0]}"
    fi

    if [[ "$actual_sha" != "$expected_sha" ]]; then
        echo "‚ùå SHA256 mismatch!"
        echo "Expected: $expected_sha"
        echo "Actual:   $actual_sha"
        exit 1
    fi

    # If it's already an ELF file, don't extract
    if file "$source_file" | grep -q "ELF"; then
        echo "‚úÖ File is already an ELF binary, skipping extraction."
        extracted_file="$source_file"
    else
        echo "üìÇ Extracting $source_file..."
        gunzip -f "$source_file"
        extracted_file="${source_file%.gz}"
    fi

    # Debugging: Show extracted file details
    echo "üîé Checking extracted file: $extracted_file"
    ls -lah "$extracted_file"
    file "$extracted_file"

    # Ensure it's an ELF executable
    if ! file "$extracted_file" | grep -q "ELF"; then
        echo "‚ùå Error: Extracted file is not a valid ELF binary!"
        exit 1
    fi

    # Check system architecture & linking
    echo "üîç Checking system architecture and linked libraries..."
    uname -m
    ldd "$extracted_file" || echo "‚ö†Ô∏è ldd failed (binary may be statically linked)"

    # Test if the binary can be executed
    echo "üöÄ Running binary to check compatibility..."
    "$extracted_file" --version || echo "‚ö†Ô∏è Binary execution failed!"

    # Install into /usr/bin/
    install -Dm755 "$extracted_file" "$pkgdir/usr/bin/asimov"
}
