pkgname=asimov-cli
pkgver=25.0.0_dev.2
pkgrel=1
pkgdesc="Asimov CLI Tool"
arch=('x86_64' 'aarch64')
url="https://github.com/asimov-platform/asimov-cli"
license=('MIT')
depends=()

# Select correct source based on architecture
case "$CARCH" in
  x86_64)
    source=("https://github.com/asimov-platform/asimov-cli/releases/download/25.0.0-dev.2/asimov-linux-x86.gz")
    sha256sums=("a64251f846d0cc0280a7f83f25f0db0c4f15ef4caf349ccd45dad22250866060")
    ;;
  aarch64)
    source=("https://github.com/asimov-platform/asimov-cli/releases/download/25.0.0-dev.2/asimov-linux-arm.gz")
    sha256sums=("e9ca2393fe6147a01f10a36bd162b8f014fcfc1e964bb65a33e6d0920b34960d")
    ;;
  *)
    echo "Unsupported architecture: $CARCH"
    exit 1
    ;;
esac

package() {
    cd "$srcdir"

    # Find the downloaded file
    source_file=$(basename "${source[0]}")

    # Debugging: List directory contents
    echo "Contents of $srcdir:"
    ls -lah "$srcdir"

    # Check if file exists
    if [[ ! -f "$source_file" ]]; then
        echo "Error: Expected file $source_file not found!"
        exit 1
    fi

    # Check the file type
    file_type=$(file -b "$source_file")

    if [[ "$file_type" == *"gzip compressed data"* ]]; then
        echo "Extracting $source_file..."
        gunzip "$source_file"
        extracted_file="${source_file%.gz}"
    else
        echo "Warning: $source_file is not a gzip file. Moving instead."
        extracted_file="${source_file%.gz}"
        mv "$source_file" "$extracted_file"
    fi

    # Check if extracted file is valid
    file "$extracted_file"

    # Ensure it's executable
    chmod +x "$extracted_file"

    # **Check if the binary architecture matches the system**
    binary_arch=$(file "$extracted_file" | grep -o 'x86-64\|ARM\|aarch64')

    if [[ "$CARCH" == "x86_64" && "$binary_arch" != "x86-64" ]]; then
        echo "Error: Downloaded binary is not x86-64 compatible!"
        exit 1
    elif [[ "$CARCH" == "aarch64" && "$binary_arch" != "aarch64" ]]; then
        echo "Error: Downloaded binary is not aarch64 compatible!"
        exit 1
    fi

    # Install into /usr/bin/
    install -Dm755 "$extracted_file" "$pkgdir/usr/bin/asimov"
}

